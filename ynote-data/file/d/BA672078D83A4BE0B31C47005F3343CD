<?xml version="1.0" encoding="UTF-8" standalone="no"?><note xmlns="http://note.youdao.com" file-version="0" schema-version="1.0.3"><head/><body><para><coId>6851-1635854813697</coId><text>容量不够，redis如何进行扩容？</text><inline-styles><font-size><from>6</from><to>13</to><value>16</value></font-size></inline-styles><styles/></para><para><coId>4471-1635855143105</coId><text>并发写操作， redis如何分摊？</text><inline-styles/><styles/></para><para><coId>2089-1635855143105</coId><text>另外，主从模式，薪火相传模式，主机宕机，导致ip地址发生变化，应用程序中配置需要修改对应的主机地址、端口等信息。</text><inline-styles><color><from>0</from><to>56</to><value>#ff0000</value></color></inline-styles><styles/></para><para><coId>3698-1635855143105</coId><text>之前通过代理主机来解决，但是redis3.0中提供了解决方案。就是无中心化集群配置。</text><inline-styles><color><from>14</from><to>22</to><value>#ff0000</value></color><color><from>33</from><to>39</to><value>#ff0000</value></color></inline-styles><styles/></para><para><coId>7127-1635857148231</coId><text/><inline-styles/><styles/></para><para><coId>1230-1635857145649</coId><text>Redis 集群实现了对Redis的水平扩容，即启动N个redis节点，将整个数据库分布存储在这N个节点中，每个节点存储总数据的1/N。</text><inline-styles><font-family><from>12</from><to>17</to><value>Times New Roman</value></font-family><font-family><from>26</from><to>27</to><value>Times New Roman</value></font-family><font-family><from>28</from><to>33</to><value>Times New Roman</value></font-family><font-family><from>48</from><to>49</to><value>Times New Roman</value></font-family><font-family><from>64</from><to>67</to><value>Times New Roman</value></font-family></inline-styles><styles/></para><para><coId>2081-1635857145896</coId><text>Redis 集群通过分区（partition）来提供一定程度的可用性（availability）： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。</text><inline-styles><font-family><from>13</from><to>22</to><value>Times New Roman</value></font-family><font-family><from>35</from><to>47</to><value>Times New Roman</value></font-family></inline-styles><styles/></para><para><coId>9520-1635857218394</coId><text/><inline-styles/><styles/></para><para><coId>8626-1635857194168</coId><text>删除持久化数据   将rdb,aof文件都删除掉。</text><inline-styles><font-family><from>11</from><to>18</to><value>Times New Roman</value></font-family></inline-styles><styles><align>justify</align></styles></para><para><coId>2094-1635857533800</coId><text/><inline-styles/><styles><align>justify</align></styles></para><para><coId>2834-1635857534097</coId><text>配置基本信息</text><inline-styles><bold><from>0</from><to>6</to><value>true</value></bold><font-family><from>0</from><to>6</to><value>SimSun</value></font-family><font-size><from>0</from><to>6</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>4731-1635857540534</coId><text>开启daemonize yes</text><inline-styles/><styles><align>justify</align></styles></para><para><coId>1047-1635857546303</coId><text>Pid文件名字</text><inline-styles><color><from>0</from><to>7</to><value>#ff0000</value></color></inline-styles><styles/></para><para><coId>0022-1635857546303</coId><text>指定端口</text><inline-styles><color><from>0</from><to>4</to><value>#ff0000</value></color></inline-styles><styles/></para><para><coId>4045-1635857546303</coId><text>Log文件名字</text><inline-styles/><styles/></para><para><coId>1959-1635857546303</coId><text>Dump.rdb名字</text><inline-styles><color><from>0</from><to>10</to><value>#ff0000</value></color></inline-styles><styles/></para><para><coId>8195-1635857546303</coId><text>Appendonly 关掉或者换名字</text><inline-styles/><styles/></para><para><coId>1441-1635857548061</coId><text>redis cluster配置修改</text><inline-styles><bold><from>0</from><to>17</to><value>true</value></bold><font-family><from>0</from><to>17</to><value>SimSun</value></font-family><font-size><from>0</from><to>17</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>8221-1635857556571</coId><text>cluster-enabled yes    打开集群模式</text><inline-styles><color><from>16</from><to>19</to><value>#ff0000</value></color></inline-styles><styles><align>justify</align></styles></para><para><coId>4490-1635857561346</coId><text>cluster-config-file nodes-6379.conf  设定节点配置文件名</text><inline-styles><color><from>20</from><to>35</to><value>#ff0000</value></color></inline-styles><styles/></para><para><coId>3161-1635857561346</coId><text>cluster-node-timeout 15000   设定节点失联时间，超过该时间（毫秒），集群自动进行主从切换。</text><inline-styles><color><from>21</from><to>26</to><value>#ff0000</value></color></inline-styles><styles/></para><table><coId>9582-1635857583602</coId><resource-list/><content>{"cells":[{"value":"include /home/bigdata/redis.conf\nport 6379\npidfile \"/var/run/redis_6379.pid\"\ndbfilename \"dump6379.rdb\"\ndir \"/home/bigdata/redis_cluster\"\nlogfile \"/home/bigdata/redis_cluster/redis_err_6379.log\"\ncluster-enabled yes\ncluster-config-file nodes-6379.conf\ncluster-node-timeout 15000","inlineStyles":{"font-family":[{"from":250,"to":276,"value":"Tahoma"}]}}],"heights":[40],"widths":[620]}</content><styles/></table><para><coId>4716-1635857577264</coId><text>修改好redis6379.conf文件，拷贝多个redis.conf文件</text><inline-styles><bold><from>0</from><to>36</to><value>true</value></bold><font-family><from>0</from><to>12</to><value>SimSun</value></font-family><font-family><from>12</from><to>17</to><value>Times New Roman</value></font-family><font-family><from>17</from><to>36</to><value>SimSun</value></font-family><font-size><from>0</from><to>36</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>9023-1635857841560</coId><text>使用查找替换修改另外5个文件</text><inline-styles><bold><from>0</from><to>14</to><value>true</value></bold><font-family><from>0</from><to>10</to><value>SimSun</value></font-family><font-family><from>10</from><to>11</to><value>Times New Roman</value></font-family><font-family><from>11</from><to>14</to><value>SimSun</value></font-family><font-size><from>0</from><to>14</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>3390-1635857848286</coId><text>例如：:%s/6379/6380 </text><inline-styles><font-family><from>4</from><to>5</to><value>SimSun</value></font-family></inline-styles><styles/></para><para><coId>8646-1635857854071</coId><text>启动6个redis服务</text><inline-styles><bold><from>0</from><to>11</to><value>true</value></bold><font-family><from>0</from><to>4</to><value>SimSun</value></font-family><font-family><from>4</from><to>9</to><value>Times New Roman</value></font-family><font-family><from>9</from><to>11</to><value>SimSun</value></font-family><font-size><from>0</from><to>11</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>6139-1635857911794</coId><text>将六个节点合成一个集群</text><inline-styles><bold><from>0</from><to>11</to><value>true</value></bold><font-family><from>0</from><to>11</to><value>SimHei</value></font-family><font-size><from>0</from><to>11</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>2120-1635857940425</coId><text>组合之前，请确保所有redis实例启动后，nodes-xxxx.conf文件都生成正常。</text><inline-styles><color><from>6</from><to>19</to><value>#e84c22</value></color></inline-styles><styles/></para><image><coId>7021-1635857978273</coId><source>https://note.youdao.com/yws/res/14400/D4DB4F53A936421085774D242B33351B</source><text/><styles><width>407</width><height>240</height></styles></image><para><coId>3623-1635857854472</coId><text>合并：</text><inline-styles/><styles/></para><para><coId>2430-1635858203023</coId><text>cd  /opt/redis-6.2.1/src</text><inline-styles/><styles/></para><para><coId>7429-1635858208494</coId><text>redis-cli --cluster create --cluster-replicas 1 192.168.11.101:6379 192.168.11.101:6380 192.168.11.101:6381 192.168.11.101:6389 192.168.11.101:6390 192.168.11.101:6391</text><inline-styles><font-family><from>0</from><to>167</to><value>Tahoma</value></font-family></inline-styles><styles/></para><para><coId>8736-1635857854628</coId><text>此处不要用127.0.0.1， 请用真实IP地址</text><inline-styles><font-family><from>20</from><to>22</to><value>Times New Roman</value></font-family><color><from>0</from><to>24</to><value>#c00000</value></color></inline-styles><styles/></para><para><coId>8826-1635858225335</coId><text>--replicas 1 采用最简单的方式配置集群，一台主机，一台从机，正好三组。</text><inline-styles><color><from>0</from><to>41</to><value>#c00000</value></color></inline-styles><styles/></para><para><coId>4511-1635857854765</coId><text/><inline-styles/><styles/></para><para><coId>3458-1635858532626</coId><text>普通方式登录</text><inline-styles/><styles/></para><para><coId>7440-1635858532626</coId><text>可能直接进入读主机，存储数据时，会出现MOVED重定向操作。所以，应该以集群方式登录。</text><inline-styles/><styles/></para><image><coId>4614-1635858544560</coId><source>https://note.youdao.com/yws/res/14407/B0A2BCEDB43D46CE9396B386DF3FD154</source><text/><styles><width>352</width><height>96</height></styles></image><para><coId>1926-1635857855551</coId><text> -c 采用集群策略连接，设置数据会自动切换到相应的写主机</text><inline-styles><bold><from>1</from><to>29</to><value>true</value></bold><font-family><from>0</from><to>1</to><value>Times New Roman</value></font-family><font-family><from>1</from><to>29</to><value>SimHei</value></font-family><font-size><from>0</from><to>1</to><value>9</value></font-size><font-size><from>1</from><to>29</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><image><coId>5458-1635858567539</coId><source>https://note.youdao.com/yws/res/14410/52D78EAC3CA94F76B5D945CB95B11BAD</source><text/><styles><width>545</width><height>136</height></styles></image><para><coId>4421-1635857855867</coId><text>通过 cluster nodes 命令查看集群信息</text><inline-styles><bold><from>0</from><to>25</to><value>true</value></bold><font-family><from>0</from><to>25</to><value>SimHei</value></font-family><font-size><from>0</from><to>25</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>4081-1635857856013</coId><text>redis cluster 如何分配这六个节点?</text><inline-styles><bold><from>0</from><to>24</to><value>true</value></bold><font-family><from>0</from><to>24</to><value>SimHei</value></font-family><font-size><from>0</from><to>24</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>4444-1635858592779</coId><text>一个集群至少要有三个主节点。</text><inline-styles><color><from>8</from><to>13</to><value>#ff0000</value></color></inline-styles><styles/></para><para><coId>8570-1635858592779</coId><text>选项 --cluster-replicas 1 表示我们希望为集群中的每个主节点创建一个从节点。</text><inline-styles/><styles/></para><para><coId>7436-1635858592779</coId><text>分配原则尽量保证每个主数据库运行在不同的IP地址，每个从库和主库不在一个IP地址上。</text><inline-styles><font-family><from>36</from><to>38</to><value>Times New Roman</value></font-family></inline-styles><styles/></para><para><coId>8095-1635857856153</coId><text/><inline-styles/><styles/></para><para><coId>1212-1635857856310</coId><text>什么是slots</text><inline-styles><bold><from>0</from><to>8</to><value>true</value></bold><font-family><from>0</from><to>3</to><value>SimHei</value></font-family><font-family><from>3</from><to>8</to><value>Arial</value></font-family><font-size><from>0</from><to>8</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>9336-1635858691735</coId><text>[OK] All nodes agree about slots configuration.</text><inline-styles><bold><from>0</from><to>47</to><value>true</value></bold><color><from>0</from><to>47</to><value>#979797</value></color></inline-styles><styles/></para><para><coId>1520-1635858691735</coId><text>&gt;&gt;&gt; Check for open slots...</text><inline-styles><bold><from>0</from><to>27</to><value>true</value></bold><color><from>0</from><to>27</to><value>#979797</value></color></inline-styles><styles/></para><para><coId>3362-1635858691735</coId><text>&gt;&gt;&gt; Check slots coverage...</text><inline-styles><bold><from>0</from><to>27</to><value>true</value></bold><color><from>0</from><to>27</to><value>#979797</value></color></inline-styles><styles/></para><para><coId>3258-1635858691735</coId><text>[OK] All 16384 slots covered.</text><inline-styles><bold><from>0</from><to>29</to><value>true</value></bold><color><from>0</from><to>29</to><value>#ff0000</value></color><back-color><from>9</from><to>14</to><value>#ffff00</value></back-color></inline-styles><styles/></para><para><coId>4976-1635858691735</coId><text>一个 Redis 集群包含 16384 个插槽（hash slot）， 数据库中的每个键都属于这 16384 个插槽的其中一个，</text><inline-styles><font-family><from>14</from><to>20</to><value>Times New Roman</value></font-family><font-family><from>24</from><to>33</to><value>Times New Roman</value></font-family><font-family><from>49</from><to>55</to><value>Times New Roman</value></font-family></inline-styles><styles/></para><para><coId>8830-1635858691735</coId><text>集群使用公式 CRC16(key) % 16384 来计算键 key 属于哪个槽， 其中 CRC16(key) 语句用于计算键 key 的 CRC16 校验和 。</text><inline-styles><font-family><from>31</from><to>35</to><value>Times New Roman</value></font-family><font-family><from>45</from><to>56</to><value>Times New Roman</value></font-family><font-family><from>64</from><to>68</to><value>Times New Roman</value></font-family><font-family><from>70</from><to>76</to><value>Times New Roman</value></font-family><font-size><from>7</from><to>12</to><value>13</value></font-size><color><from>7</from><to>20</to><value>#ff0000</value></color></inline-styles><styles/></para><para><coId>5090-1635858691735</coId><text>集群中的每个节点负责处理一部分插槽。 举个例子， 如果一个集群可以有主节点， 其中：</text><inline-styles/><styles/></para><para><coId>8673-1635858691735</coId><text>节点 A 负责处理 0 号至 5460 号插槽。</text><inline-styles/><styles/></para><para><coId>7970-1635858691735</coId><text>节点 B 负责处理 5461 号至 10922 号插槽。</text><inline-styles/><styles/></para><para><coId>7070-1635858691735</coId><text>节点 C 负责处理 10923 号至 16383 号插槽。</text><inline-styles/><styles/></para><para><coId>3460-1635935852679</coId><text>在集群中录入值</text><inline-styles><bold><from>0</from><to>7</to><value>true</value></bold><font-family><from>0</from><to>7</to><value>SimHei</value></font-family><font-size><from>0</from><to>7</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>4868-1635935852944</coId><text>在redis-cli每次录入、查询键值，redis都会计算出该key应该送往的插槽，如果不是该客户端对应服务器的插槽，redis会报错，并告知应前往的redis实例地址和端口。</text><inline-styles><font-family><from>20</from><to>25</to><value>Times New Roman</value></font-family><font-family><from>31</from><to>34</to><value>Times New Roman</value></font-family><font-family><from>59</from><to>64</to><value>Times New Roman</value></font-family><font-family><from>75</from><to>80</to><value>Times New Roman</value></font-family></inline-styles><styles/></para><para><coId>7434-1635935852944</coId><text>redis-cli客户端提供了 –c 参数实现自动重定向。</text><inline-styles><font-family><from>17</from><to>19</to><value>Times New Roman</value></font-family><color><from>16</from><to>28</to><value>#ff0000</value></color></inline-styles><styles/></para><para><coId>1820-1635935852944</coId><text>如 redis-cli  -c –p 6379 登入后，再录入、查询键值对可以自动重定向。</text><inline-styles><font-family><from>17</from><to>23</to><value>Times New Roman</value></font-family><color><from>2</from><to>23</to><value>#ff0000</value></color><back-color><from>13</from><to>15</to><value>#ffff00</value></back-color></inline-styles><styles/></para><para><coId>8078-1635857856458</coId><text>不在一个slot下的键值，是不能使用mget,mset等多键操作。</text><inline-styles><color><from>14</from><to>32</to><value>#ff0000</value></color></inline-styles><styles/></para><para><coId>2788-1635935882724</coId><text>可以通过{}来定义组的概念，从而使key中{}内相同内容的键值对放到一个slot中去。</text><inline-styles><font-family><from>17</from><to>20</to><value>Times New Roman</value></font-family><font-family><from>21</from><to>23</to><value>Times New Roman</value></font-family><font-family><from>36</from><to>40</to><value>Times New Roman</value></font-family></inline-styles><styles/></para><para><coId>5754-1635857856621</coId><text>查询集群中的值</text><inline-styles><bold><from>0</from><to>7</to><value>true</value></bold><font-family><from>0</from><to>7</to><value>SimHei</value></font-family><font-size><from>0</from><to>7</to><value>21</value></font-size></inline-styles><styles><align>justify</align></styles></para><para><coId>8014-1635935893243</coId><text>CLUSTER GETKEYSINSLOT &lt;slot&gt;&lt;count&gt; 返回 count 个 slot 槽中的键。</text><inline-styles><font-family><from>38</from><to>45</to><value>Times New Roman</value></font-family><font-family><from>46</from><to>52</to><value>Times New Roman</value></font-family></inline-styles><styles/></para><para><coId>5875-1635936165031</coId><text/><inline-styles/><styles/></para><para><coId>8160-1635936165170</coId><text/><inline-styles/><styles/></para><para><coId>2521-1635936165316</coId><text/><inline-styles/><styles/></para><heading compat="true" level="1"><coId>8137-1635936165452</coId><text>集群jedis操作</text><inline-styles><bold><from>0</from><to>9</to><value>true</value></bold><font-size><from>0</from><to>9</to><value>28</value></font-size></inline-styles><styles/></heading><para><coId>3530-1635936359456</coId><text>即使连接的不是主机，集群会自动切换主机存储。主机写，从机读。</text><inline-styles/><styles/></para><para><coId>2675-1635936385155</coId><text>无中心化主从集群。无论从哪台主机写的数据，其他主机上都能读到数据。</text><inline-styles/><styles/></para><table><coId>6082-1635936401654</coId><resource-list/><content>{"cells":[{"value":"public class JedisClusterTest {\npublic static void main(String[] args) { \nSet&lt;HostAndPort&gt;set =new HashSet&lt;HostAndPort&gt;();\n     set.add(new HostAndPort(\"192.168.31.211\",6379));\nJedisCluster jedisCluster=new JedisCluster(set);\n     jedisCluster.set(\"k1\", \"v1\");\nSystem.out.println(jedisCluster.get(\"k1\"));\n  }\n}","inlineStyles":{"italic":[{"from":268,"to":304,"value":true}],"font-family":[{"from":309,"to":310,"value":"Tahoma"}],"color":[{"from":0,"to":6,"value":"#7f0055"},{"from":7,"to":12,"value":"#7f0055"},{"from":32,"to":38,"value":"#7f0055"},{"from":39,"to":45,"value":"#7f0055"},{"from":46,"to":51,"value":"#7f0055"},{"from":65,"to":69,"value":"#6a3e3e"},{"from":72,"to":73,"value":"#3f7f5f"},{"from":90,"to":93,"value":"#6a3e3e"},{"from":95,"to":98,"value":"#7f0055"},{"from":123,"to":131,"value":"#6a3e3e"},{"from":136,"to":139,"value":"#7f0055"},{"from":152,"to":168,"value":"#2a00ff"},{"from":190,"to":202,"value":"#6a3e3e"},{"from":203,"to":206,"value":"#7f0055"},{"from":220,"to":223,"value":"#6a3e3e"},{"from":226,"to":243,"value":"#6a3e3e"},{"from":248,"to":252,"value":"#2a00ff"},{"from":254,"to":258,"value":"#2a00ff"},{"from":268,"to":271,"value":"#0000c0"},{"from":280,"to":292,"value":"#6a3e3e"},{"from":297,"to":301,"value":"#2a00ff"}]}}],"heights":[40],"widths":[618]}</content><styles/></table><para><coId>2969-1635936395272</coId><text/><inline-styles/><styles/></para></body></note>